services:
  # openclaw-gateway: DESACTIVE â€” non utilise par iFIND, cause restart loop
  # Pour reactiver, decommentez et corrigez les permissions

  telegram-router:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    user: "root"
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      HUBSPOT_API_KEY: ${HUBSPOT_API_KEY}
      APOLLO_API_KEY: ${APOLLO_API_KEY}
      FULLENRICH_API_KEY: ${FULLENRICH_API_KEY}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      RESEND_API_KEY: ${RESEND_API_KEY}
      SENDER_EMAIL: ${SENDER_EMAIL:-onboarding@resend.dev}
      GMAIL_SMTP_USER: ${GMAIL_SMTP_USER:-}
      GMAIL_SMTP_PASS: ${GMAIL_SMTP_PASS:-}
      GMAIL_SMTP_ENABLED: ${GMAIL_SMTP_ENABLED:-false}
      FLOWFAST_DATA_DIR: /data/flowfast
      AUTOMAILER_DATA_DIR: /data/automailer
      CRM_PILOT_DATA_DIR: /data/crm-pilot
      LEAD_ENRICH_DATA_DIR: /data/lead-enrich
      CONTENT_GEN_DATA_DIR: /data/content-gen
      INVOICE_BOT_DATA_DIR: /data/invoice-bot
      PROACTIVE_DATA_DIR: /data/proactive-agent
      SELF_IMPROVE_DATA_DIR: /data/self-improve
      WEB_INTEL_DATA_DIR: /data/web-intelligence
      SYSTEM_ADVISOR_DATA_DIR: /data/system-advisor
      AUTONOMOUS_PILOT_DATA_DIR: /data/autonomous-pilot
      APP_CONFIG_DIR: /data/app-config
      API_DAILY_BUDGET: ${API_DAILY_BUDGET:-5}
      ADMIN_CHAT_ID: ${ADMIN_CHAT_ID:-1409505520}
      RESEND_WEBHOOK_SECRET: ${RESEND_WEBHOOK_SECRET:-}
      IMAP_HOST: ${IMAP_HOST:-}
      IMAP_PORT: ${IMAP_PORT:-993}
      IMAP_USER: ${IMAP_USER:-}
      IMAP_PASS: ${IMAP_PASS:-}
      CALCOM_API_KEY: ${CALCOM_API_KEY:-}
      INBOX_MANAGER_DATA_DIR: /data/inbox-manager
      MEETING_SCHEDULER_DATA_DIR: /data/meeting-scheduler
    ports:
      - "127.0.0.1:9090:9090"
    volumes:
      - ./gateway:/app/gateway
      - ./skills/flowfast:/app/skills/flowfast
      - ./skills/automailer:/app/skills/automailer
      - ./skills/crm-pilot:/app/skills/crm-pilot
      - ./skills/lead-enrich:/app/skills/lead-enrich
      - ./skills/content-gen:/app/skills/content-gen
      - ./skills/invoice-bot:/app/skills/invoice-bot
      - ./skills/proactive-agent:/app/skills/proactive-agent
      - ./skills/self-improve:/app/skills/self-improve
      - ./skills/web-intelligence:/app/skills/web-intelligence
      - ./skills/system-advisor:/app/skills/system-advisor
      - ./skills/autonomous-pilot:/app/skills/autonomous-pilot
      - ./skills/inbox-manager:/app/skills/inbox-manager
      - ./skills/meeting-scheduler:/app/skills/meeting-scheduler
      - flowfast-data:/data/flowfast
      - automailer-data:/data/automailer
      - crm-pilot-data:/data/crm-pilot
      - lead-enrich-data:/data/lead-enrich
      - content-gen-data:/data/content-gen
      - invoice-bot-data:/data/invoice-bot
      - proactive-agent-data:/data/proactive-agent
      - self-improve-data:/data/self-improve
      - web-intelligence-data:/data/web-intelligence
      - system-advisor-data:/data/system-advisor
      - autonomous-pilot-data:/data/autonomous-pilot
      - inbox-manager-data:/data/inbox-manager
      - meeting-scheduler-data:/data/meeting-scheduler
      - app-config-data:/data/app-config
    init: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    entrypoint: ["sh", "-c", "mkdir -p /data/flowfast /data/automailer /data/crm-pilot /data/lead-enrich /data/content-gen /data/invoice-bot /data/proactive-agent /data/self-improve /data/web-intelligence /data/system-advisor /data/autonomous-pilot /data/inbox-manager /data/meeting-scheduler /data/app-config && chown -R node:node /data/flowfast /data/automailer /data/crm-pilot /data/lead-enrich /data/content-gen /data/invoice-bot /data/proactive-agent /data/self-improve /data/web-intelligence /data/system-advisor /data/autonomous-pilot /data/inbox-manager /data/meeting-scheduler /data/app-config && cd /app && exec runuser -u node -- node /app/gateway/telegram-router.js"]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "node", "-e", "const h=require('http');h.get('http://localhost:9090/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mission-control:
    image: node:20-alpine
    working_dir: /app
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    environment:
      DASHBOARD_PORT: "3000"
      DASHBOARD_PASSWORD: ${DASHBOARD_PASSWORD}
      DASHBOARD_OWNER: ${DASHBOARD_OWNER:-}
      FLOWFAST_DATA_DIR: /data/flowfast
      AUTOMAILER_DATA_DIR: /data/automailer
      CRM_PILOT_DATA_DIR: /data/crm-pilot
      LEAD_ENRICH_DATA_DIR: /data/lead-enrich
      CONTENT_GEN_DATA_DIR: /data/content-gen
      INVOICE_BOT_DATA_DIR: /data/invoice-bot
      PROACTIVE_DATA_DIR: /data/proactive-agent
      SELF_IMPROVE_DATA_DIR: /data/self-improve
      WEB_INTEL_DATA_DIR: /data/web-intelligence
      SYSTEM_ADVISOR_DATA_DIR: /data/system-advisor
      AUTONOMOUS_PILOT_DATA_DIR: /data/autonomous-pilot
      INBOX_MANAGER_DATA_DIR: /data/inbox-manager
      MEETING_SCHEDULER_DATA_DIR: /data/meeting-scheduler
      APP_CONFIG_DIR: /data/app-config
      DASHBOARD_DATA_DIR: /data/dashboard
    volumes:
      - ./dashboard:/app
      - ./gateway/logger.js:/gateway/logger.js:ro
      - dashboard-data:/data/dashboard
      - flowfast-data:/data/flowfast:ro
      - automailer-data:/data/automailer:ro
      - crm-pilot-data:/data/crm-pilot:ro
      - lead-enrich-data:/data/lead-enrich:ro
      - content-gen-data:/data/content-gen:ro
      - invoice-bot-data:/data/invoice-bot:ro
      - proactive-agent-data:/data/proactive-agent:ro
      - self-improve-data:/data/self-improve:ro
      - web-intelligence-data:/data/web-intelligence:ro
      - system-advisor-data:/data/system-advisor:ro
      - autonomous-pilot-data:/data/autonomous-pilot:ro
      - inbox-manager-data:/data/inbox-manager:ro
      - meeting-scheduler-data:/data/meeting-scheduler:ro
      - app-config-data:/data/app-config:ro
    ports:
      - "127.0.0.1:3000:3000"
    init: true
    restart: unless-stopped
    entrypoint: ["sh", "-c", "cd /app && npm install --production 2>/dev/null; node server.js"]
    healthcheck:
      test: ["CMD", "node", "-e", "const h=require('http');h.get('http://localhost:3000/login',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  landing-page:
    image: node:20-alpine
    working_dir: /app
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
    environment:
      LANDING_PORT: "3080"
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      ADMIN_CHAT_ID: ${ADMIN_CHAT_ID:-1409505520}
    volumes:
      - ./landing:/app
    ports:
      - "127.0.0.1:3080:3080"
    init: true
    restart: unless-stopped
    entrypoint: ["sh", "-c", "cd /app && npm install --production 2>/dev/null; node server.js"]
    healthcheck:
      test: ["CMD", "node", "-e", "const h=require('http');h.get('http://localhost:3080',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  dashboard-data:
  flowfast-data:
  automailer-data:
  crm-pilot-data:
  lead-enrich-data:
  content-gen-data:
  invoice-bot-data:
  proactive-agent-data:
  self-improve-data:
  web-intelligence-data:
  system-advisor-data:
  autonomous-pilot-data:
  inbox-manager-data:
  meeting-scheduler-data:
  app-config-data:
    name: moltbot_app-config-data
    external: true
